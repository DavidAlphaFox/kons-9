(in-package #:kons-9)

;;;; atomic data and colors ====================================================

;; atomic covalent radii in picometers (0.01 angstroms)
;;; https://www.schoolmykids.com/learn/periodic-table/covalent-radius-of-all-the-elements
(defparameter *atomic-data*
  (vector
   #(1 H Hydrogen 37)
   #(2 He Helium 32)
   #(3 Li Lithium 134)
   #(4 Be Beryllium 90)
   #(5 B Boron 82)
   #(6 C Carbon 77)
   #(7 N Nitrogen 75)
   #(8 O Oxygen 73)
   #(9 F Fluorine 71)
   #(10 Ne Neon 69)
   #(11 Na Sodium 154)
   #(12 Mg Magnesium 130)
   #(13 Al Aluminium 118)
   #(14 Si Silicon 111)
   #(15 P Phosphorus 106)
   #(16 S Sulfur 102)
   #(17 Cl Chlorine 99)
   #(18 Ar Argon 97)
   #(19 K Potassium 196)
   #(20 Ca Calcium 174)
   #(21 Sc Scandium 144)
   #(22 Ti Titanium 136)
   #(23 V Vanadium 125)
   #(24 Cr Chromium 127)
   #(25 Mn Manganese 139)
   #(26 Fe Iron 125)
   #(27 Co Cobalt 126)
   #(28 Ni Nickel 121)
   #(29 Cu Copper 138)
   #(30 Zn Zinc 131)
   #(31 Ga Gallium 126)
   #(32 Ge Germanium 122)
   #(33 As Arsenic 119)
   #(34 Se Selenium 116)
   #(35 Br Bromine 114)
   #(36 Kr Krypton 110)
   #(37 Rb Rubidium 211)
   #(38 Sr Strontium 192)
   #(39 Y Yttrium 162)
   #(40 Zr Zirconium 148)
   #(41 Nb Niobium 137)
   #(42 Mo Molybdenum 145)
   #(43 Tc Technetium 156)
   #(44 Ru Ruthenium 126)
   #(45 Rh Rhodium 135)
   #(46 Pd Palladium 131)
   #(47 Ag Silver 153)
   #(48 Cd Cadmium 148)
   #(49 In Indium 144)
   #(50 Sn Tin 141)
   #(51 Sb Antimony 138)
   #(52 Te Tellurium 135)
   #(53 I Iodine 133)
   #(54 Xe Xenon 130)
   #(55 Cs Cesium 225)
   #(56 Ba Barium 198)
   #(57 La Lanthanum 169)
   #(58 Ce Cerium nil)
   #(59 Pr Praseodymium nil)
   #(60 Nd Neodymium nil)
   #(61 Pm Promethium nil)
   #(62 Sm Samarium nil)
   #(63 Eu Europium nil)
   #(64 Gd Gadolinium nil)
   #(65 Tb Terbium nil)
   #(66 Dy Dysprosium nil)
   #(67 Ho Holmium nil)
   #(68 Er Erbium nil)
   #(69 Tm Thulium nil)
   #(70 Yb Ytterbium nil)
   #(71 Lu Lutetium 160)
   #(72 Hf Hafnium 150)
   #(73 Ta Tantalum 138)
   #(74 W Tungsten 146)
   #(75 Re Rhenium 159)
   #(76 Os Osmium 128)
   #(77 Ir Iridium 137)
   #(78 Pt Platinum 128)
   #(79 Au Gold 144)
   #(80 Hg Mercury 149)
   #(81 Tl Thallium 148)
   #(82 Pb Lead 147)
   #(83 Bi Bismuth 146)
   #(84 Po Polonium nil)
   #(85 At Astatine nil)
   #(86 Rn Radon 145)
   #(87 Fr Francium nil)
   #(88 Ra Radium nil)
   #(89 Ac Actinium nil)
   #(90 Th Thorium nil)
   #(91 Pa Protactinium nil)
   #(92 U Uranium nil)
   #(93 Np Neptunium nil)
   #(94 Pu Plutonium nil)
   #(95 Am Americium nil)
   #(96 Cm Curium nil)
   #(97 Bk Berkelium nil)
   #(98 Cf Californium nil)
   #(99 Es Einsteinium nil)
   #(100 Fm Fermium nil)
   #(101 Md Mendelevium nil)
   #(102 No Nobelium nil)
   #(103 Lr Lawrencium nil)
   #(104 Rf Rutherfordium nil)
   #(105 Db Dubnium nil)
   #(106 Sg Seaborgium nil)
   #(107 Bh Bohrium nil)
   #(108 Hs Hassium nil)
   #(109 Mt Meitnerium nil)
   #(110 Ds Darmstadtium nil)
   #(111 Rg Roentgenium nil)
   #(112 Cn Copernicium nil)
   #(113 Nh Nihonium nil)
   #(114 Fl Flerovium nil)
   #(115 Mc Moscovium nil)
   #(116 Lv Livermorium nil)
   #(117 Ts Tennessine nil)
   #(118 Og Oganesson nil)
   ))

;;; conventional colors for atoms
;;; https://sciencenotes.org/molecule-atom-colors-cpk-colors/
(defparameter *atomic-colors*
  (vector
   #(1 H #(255 255 255))
   #(2 He #(217 255 255))
   #(3 Li #(204 128 255))
   #(4 Be #(194 255 0))
   #(5 B #(255 181 181))
   #(6 C #(144 144 144))
   #(7 N #(48 80 248))
   #(8 O #(255 13 13))
   #(9 F #(144 224 80))
   #(10 Ne #(179 227 245))
   #(11 Na #(171 92 242))
   #(12 Mg #(138 255 0))
   #(13 Al #(191 166 166))
   #(14 Si #(240 200 160))
   #(15 P #(255 128 0))
   #(16 S #(255 255 48))
   #(17 Cl #(31 240 31))
   #(18 Ar #(128 209 227))
   #(19 K #(143 64 212))
   #(20 Ca #(61 255 0))
   #(21 Sc #(230 230 230))
   #(22 Ti #(191 194 199))
   #(23 V #(166 166 171))
   #(24 Cr #(138 153 199))
   #(25 Mn #(156 122 199))
   #(26 Fe #(224 102 51))
   #(27 Co #(240 144 160))
   #(28 Ni #(80 208 80))
   #(29 Cu #(200 128 51))
   #(30 Zn #(125 128 176))
   #(31 Ga #(194 143 143))
   #(32 Ge #(102 143 143))
   #(33 As #(189 128 227))
   #(34 Se #(255 161 0))
   #(35 Br #(166 41 41))
   #(36 Kr #(92 184 209))
   #(37 Rb #(112 46 176))
   #(38 Sr #(0 255 0))
   #(39 Y #(148 255 255))
   #(40 Zr #(148 224 224))
   #(41 Nb #(115 194 201))
   #(42 Mo #(84 181 181))
   #(43 Tc #(59 158 158))
   #(44 Ru #(36 143 143))
   #(45 Rh #(10 125 140))
   #(46 Pd #(0 105 133))
   #(47 Ag #(192 192 192))
   #(48 Cd #(255 217 143))
   #(49 In #(166 117 115))
   #(50 Sn #(102 128 128))
   #(51 Sb #(158 99 181))
   #(52 Te #(212 122 0))
   #(53 I #(148 0 148))
   #(54 Xe #(66 158 176))
   #(55 Cs #(87 23 143))
   #(56 Ba #(0 201 0))
   #(57 La #(112 212 255))
   #(58 Ce #(255 255 199))
   #(59 Pr #(217 255 199))
   #(60 Nd #(199 255 199))
   #(61 Pm #(163 255 199))
   #(62 Sm #(143 255 199))
   #(63 Eu #(97 255 199))
   #(64 Gd #(69 255 199))
   #(65 Tb #(48 255 199))
   #(66 Dy #(31 255 199))
   #(67 Ho #(0 255 156))
   #(68 Er #(0 230 117))
   #(69 Tm #(0 212 82))
   #(70 Yb #(0 191 56))
   #(71 Lu #(0 171 36))
   #(72 Hf #(77 194 255))
   #(73 Ta #(77 166 255))
   #(74 W #(33 148 214))
   #(75 Re #(38 125 171))
   #(76 Os #(38 102 150))
   #(77 Ir #(23 84 135))
   #(78 Pt #(208 208 224))
   #(79 Au #(255 209 35))
   #(80 Hg #(184 184 208))
   #(81 Tl #(166 84 77))
   #(82 Pb #(87 89 97))
   #(83 Bi #(158 79 181))
   #(84 Po #(171 92 0))
   #(85 At #(117 79 69))
   #(86 Rn #(66 130 150))
   #(87 Fr #(66 0 102))
   #(88 Ra #(0 125 0))
   #(89 Ac #(112 171 250))
   #(90 Th #(0 186 255))
   #(91 Pa #(0 161 255))
   #(92 U #(0 143 255))
   #(93 Np #(0 128 255))
   #(94 Pu #(0 107 255))
   #(95 Am #(84 92 242))
   #(96 Cm #(120 92 227))
   #(97 Bk #(138 79 227))
   #(98 Cf #(161 54 212))
   #(99 Es #(179 31 212))
   #(100 Fm #(179 31 186))
   #(101 Md #(179 13 166))
   #(102 No #(189 13 135))
   #(103 Lr #(199 0 102))
   #(104 Rf #(204 0 89))
   #(105 Db #(209 0 79))
   #(106 Sg #(217 0 69))
   #(107 Bh #(224 0 56))
   #(108 Hs #(230 0 46))
   #(109 Mt #(235 0 38))
   #(110 Ds #(200 200 200))
   #(111 Rg #(200 200 200))
   #(112 Cn #(200 200 200))
   #(113 Nh #(200 200 200))
   #(114 Fl #(200 200 200))
   #(115 Mc #(200 200 200))
   #(116 Lv #(200 200 200))
   #(117 Ts #(200 200 200))
   #(118 Og #(200 200 200))
   ))

;;;; atom data and color utilities =============================================

(defun element-covalent-radius-in-picometers (data)
  (aref data 3))

(defun atom-diameter-in-angstroms (element)
  (let ((atom-data (find element *atomic-data* :key (lambda (data) (aref data 1)))))
    (if atom-data
        (let ((radius (element-covalent-radius-in-picometers atom-data)))
          (if radius
              (* 2 0.01 radius)  ; convert picometer radius to angstrom diameter
              (error "Element ~a covalent radius is unknown." element)))
        (error "Element ~a not found." element))))

(defun element-color-255 (data)
  (aref data 2))

(defun atom-color (element)
  (let ((atom-data (find element *atomic-colors* :key (lambda (data) (aref data 1)))))
    (if atom-data
        (let ((rgb (element-color-255 atom-data)))
          (if rgb
              ;; convert color from 0-255 to 0.0-1.0
              (c! (/ (aref rgb 0) 255.0) (/ (aref rgb 1) 255.0) (/ (aref rgb 2) 255.0))
              (error "Element ~a color is unknown." element)))
        (error "Element ~a not found." element))))

(defun make-atom-sphere (element x y z &optional (scale 1.0))
  (let ((shape (translate-to (make-cube-sphere (* (atom-diameter-in-angstroms element) scale) 3)
                             (p! x y z))))
    (set-point-colors-uniform shape (atom-color element))))

;;;; xyz format import =========================================================

(defun import-xyz (filename)
  (with-open-file (stream filename :direction :input :if-does-not-exist :error)
    (read-xyz stream)))

(defun read-xyz (stream)
  (let ((atoms (make-array 0 :adjustable t :fill-pointer t)) ;atom is just a cube-sphere
        (num-atoms (read stream))
        (molecule-name (read-line stream)))
    (declare (ignore molecule-name))
    (dotimes (i num-atoms)
      (parse-xyz-atom stream atoms))
    (make-shape-group (array->list atoms))))

(defun parse-xyz-atom (s atoms)
  (vector-push-extend (make-atom-sphere (read s) (read s) (read s) (read s)) atoms)) ;element x y z

;;;; mol format import =========================================================

(defun import-mol (filename &key (show-bonds? nil))
  (with-open-file (stream filename :direction :input :if-does-not-exist :error)
    (read-mol stream show-bonds?)))

(defun read-mol (stream show-bonds?)
  ;; skip over uninteresting lines
  (dotimes (i 3)
    (read-line stream))
  (let* ((shapes (make-array 0 :adjustable t :fill-pointer t))
         (num-atoms (read stream))
         (num-bonds (read stream))
         (misc-data-string (read-line stream))
         (version  (read-from-string misc-data-string t nil :start (- (length misc-data-string) 5))))
    ;; ensure version is V2000
    (when (not (string-equal "V2000" version))
      (error "Unsupported MOL file version ~a" version))
    (dotimes (i num-atoms)
      (parse-mol-atom stream shapes
                      ;; use 0.5 scale when showing bonds
                      (if show-bonds? 0.5 1.0)))
    (when show-bonds?
      (dotimes (i num-bonds)
        (parse-mol-bond stream shapes)))
    (make-shape-group (array->list shapes))))

(defun parse-mol-atom (s shapes &optional (scale 1.0))
  (let ((x (read s))
        (y (read s))
        (z (read s))
        (element (read s)))
    (read-line s)                  ;read and ignore rest of atom line
    (vector-push-extend (make-atom-sphere element x y z scale) shapes)))

(defun parse-mol-bond (s shapes &optional (scale 1.0))
  (let* ((atom-1 (1- (read s)))
         (atom-2 (1- (read s)))
         (point-1 (offset (translate (transform (aref shapes atom-1)))))
         (point-2 (offset (translate (transform (aref shapes atom-2))))))
    (read-line s)                  ;read and ignore rest of atom line
    (vector-push-extend (make-atom-bond point-1 point-2 scale) shapes)))

(defun make-atom-bond (point-1 point-2 &optional (scale 1.0))
  (make-cylinder-uv-mesh-between-points (* 0.1 scale) point-1 point-2 8 1))
